#!groovy
/*
 * Build Java Artifacts
 */

def now = new Date()
date = now.format("yyyyMMdd-HHmm", TimeZone.getTimeZone('UTC'))

pipeline {
  // agent { label 'cbc-aws-g3-agent' }
  // agent { label 'cbc-aws-g3-agent-ops' }
  //  agent { label 'gce-node' }
  agent { label 'docker-agent' }

    environment {
        MODULE = 'vulnadoava'
        DOCKER_FILE = "Dockerfile.${MODULE}"
        DOCKERHUB_CREDS = "dockerhub_creds"
        DOCKERHUB_ORG = "cbcdevdockerhub"
        DOCKERHUB_REPO = "cbcdev"
        VERSION = "${date}"
        GIT_TAG = "1v1.0.344-SNAPSHOT"

    }

    options {
        // disableConcurrentBuilds()
        skipDefaultCheckout()
        skipStagesAfterUnstable()
        // timestamps()
        ansiColor('xterm')
    }

    triggers {
        githubPush()
    }

    stages {

        stage('Start') {
          steps {
            cleanWs()
          }
        }

        stage('Checkout') {
          steps {
            deleteDir()
            checkout scm
          }
        }

        // stage('Pre-build') {
        //   steps {
        //     script {
        //         GIT_TAG = sh (script: "git describe --tags --always", returnStdout: true).trim()
        //       }
        //     }
        //   }

    stage('Git-TAG-Verify') {
      steps {
        script {
          if (GIT_TAG ==~ /^v[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/) {
            sh "set +x && echo -e '\033[0;35m Valid TAG :\033[0m \033[0;34m ${GIT_TAG} \033[0m'"
          }
          else if (GIT_TAG ==~ /^v[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-SNAPSHOT/) {
            sh "set +x && echo -e '\033[0;35m Valid TAG :\033[0m \033[0;34m ${GIT_TAG} \033[0m'"
          }
          else {
            sh "set +x && echo -e '\033[31m ${GIT_TAG} is an invalid TAG...!!! The TAG should be like vX.Y.Z OR vX.Y.Z-SNAPSHOT, where X, Y and Z can be maximum 3 digits. Some examples follows. \033[0m \n \n\t- \033[32mv1.1.1\033[0m \n\t- \033[32mv123.456.789 \033[0m \n\t- \033[32mv1.0.0-SNAPSHOT\033[0m \n\t- \033[32mv987.654.321-SNAPSHOT\033[0m \n\t' && exit 1"
          }
        }
      }
    }


        // stage('Build') {
        //   steps {
        //     withCredentials([

        //         [$class: 'FileBinding',
        //         credentialsId: 'maven-settings-xml-internal',
        //         variable: 'SETTINGS_XML']]) {
        //             sh '''
        //                 mkdir -p .m2 || true
        //                 cp $SETTINGS_XML .m2/settings.xml
        //                 docker build -t ${MODULE}  -f $DOCKER_FILE .
        //                 ID=$(docker create ${MODULE})
        //                 echo ${ID}
        //                 docker cp ${ID}:/src/target ./
        //                 docker rm ${ID}
        //                 pwd
        //                 ls target
        //                 '''
        //         }
        //     }
        // }


        // stage('DockerHub:Push') {
        //   steps {
        //     script {
        //         sh "docker tag $MODULE $TARGET_DOCKERHUB"
        //         sh "docker push -q $TARGET_DOCKERHUB"
        //     }
        //   }
        // }


    }

    // post {
    //     always {
    //         archiveArtifacts artifacts: 'target/*.jar', onlyIfSuccessful: true
    //     }
    // }

}
